---
- name: Edit packer variables
  replace:
    path: ./roles/packerMe/files/packer.json
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  with_items:
    - { regexp: "\"profile\": \".*\"", replace: "\"profile\": \"{{ AWS_PROFILE }}\"" }
    - { regexp: "\"region\": \".*\"", replace: "\"region\": \"{{ AWS_REGION }}\"" }

- name: Remove old manifest file
  file:
    path: manifest.json
    state: absent

- name: Building AMI
  command: "{{ lookup('file', 'files/call_packer.sh') }}"

- name: Extract ZONE:AMI_ID from manifest
  set_fact:
    ami_id: "{{ lookup('file', 'manifest.json') | from_json | json_query('builds[].artifact_id')}}"

- name: State new AMI ID
  debug:
    msg: "Created AMI: {{ ami_id[0].split(':')[1] }}"

- name: Setup terraform file
  replace:
    path: ./terraform/terraform.tfvars
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  with_items:
    - { regexp: "{{ ami_id[0].split(':')[0] }} = \"ami-.*\"", replace: "{{ ami_id[0].split(':')[0] }} = \"{{ ami_id[0].split(':')[1] }}\"" }
    - { regexp: "INSTANCE_SIZE = \".*\"", replace: "INSTANCE_SIZE = \"{{ AWS_INSTANCE_SIZE }}\"" }
    - { regexp: "AWS_PROFILE = \".*\"", replace: "AWS_PROFILE = \"{{ AWS_PROFILE }}\"" }
    - { regexp: "AWS_REGION = \".*\"", replace: "AWS_REGION = \"{{ AWS_REGION }}\"" }
    # TODO:
    # - { regexp: "availability_zones   = \\[.*\\]\"", replace: "availability_zones   = \\[{{ AVAILABILITY_ZONES }}\\]\"" }