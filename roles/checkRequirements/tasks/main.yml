---
- name: Deleting variables.json
  file:
    path: variables.json
    state: absent
  when: variables_delete == 'yes'

- name: Checking if variables.json exist
  stat:
    path: variables.json
  register: variables

- name: Load vars
  include_vars:
    file: variables.json
  when: variables.stat.exists

- name: Check if packer installed (boolean output)
  shell: 'which packer | wc -l'
  register: isPacker
  failed_when: "'0' in isPacker.stdout"

- name: Check if terraform installed (boolean output)
  shell: 'which terraform | wc -l'
  register: isTerraform
  failed_when: "'0' in isTerraform.stdout"

- name: "Ensure required variables are set"
  fail:
    msg: "The {{item}} variable is not defined"
  when: vars[item] is undefined
  loop:
  - AWS_REGION
  - AWS_PROFILE
  - AWS_INSTANCE_SIZE
  - AWS_OWNER_ID
  - AMI_NAME
  - SSH_USER
  - OS_FAMILY
  - OS_VERSION

- debug: 
    msg: "I'm expecting to have AWS-CLI and MFA setup correctly on build machine"
